# syntax=docker/dockerfile:1.6

################
#     BASE     #
################
ARG PYTHON_VERSION=3.11.6
ARG DEBIAN_BASE=bookworm
FROM python:${PYTHON_VERSION}-slim-${DEBIAN_BASE} AS base

ARG WKHTMLTOPDF_VERSION=0.12.6.1-3
ARG WKHTMLTOPDF_DISTRO=bookworm
ARG NODE_VERSION=20.19.2
ENV NVM_DIR=/home/frappe/.nvm
ENV PATH=${NVM_DIR}/versions/node/v${NODE_VERSION}/bin/:${PATH}

RUN useradd -ms /bin/bash frappe \
 && apt-get update \
 && apt-get install --no-install-recommends -y \
    curl git vim file ca-certificates \
    libpango-1.0-0 libharfbuzz0b libpangoft2-1.0-0 libpangocairo-1.0-0 \
    restic gpg \
    mariadb-client less libpq-dev postgresql-client \
    jq wget \
    tini gosu libcap2-bin \
    redis-tools \
 && mkdir -p ${NVM_DIR} \
 && curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash \
 && . ${NVM_DIR}/nvm.sh \
 && nvm install ${NODE_VERSION} \
 && nvm use ${NODE_VERSION} \
 && npm install -g yarn \
 && nvm alias default ${NODE_VERSION} \
 && rm -rf ${NVM_DIR}/.cache \
 && echo 'export NVM_DIR="/home/frappe/.nvm"' >> /home/frappe/.bashrc \
 && echo '[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"' >> /home/frappe/.bashrc \
 && echo '[ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"' >> /home/frappe/.bashrc \
 && ln -sf ${NVM_DIR}/versions/node/v${NODE_VERSION}/bin/node /usr/local/bin/node \
 && ln -sf ${NVM_DIR}/versions/node/v${NODE_VERSION}/bin/npm  /usr/local/bin/npm  \
 && ln -sf ${NVM_DIR}/versions/node/v${NODE_VERSION}/bin/yarn /usr/local/bin/yarn \
 && chown -R frappe:frappe ${NVM_DIR} \
 && export ARCH="$( [ "$(uname -m)" = "aarch64" ] && echo arm64 || echo amd64 )" \
 && f=wkhtmltox_${WKHTMLTOPDF_VERSION}.${WKHTMLTOPDF_DISTRO}_${ARCH}.deb \
 && curl -sLO https://github.com/wkhtmltopdf/packaging/releases/download/${WKHTMLTOPDF_VERSION}/${f} \
 && apt-get install -y ./${f} \
 && rm -f ${f} \
 && rm -rf /var/lib/apt/lists/* \
 && pip3 install --no-cache-dir frappe-bench

###################
#     BUILDER     #
###################
FROM base AS builder

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

RUN set -euo pipefail; \
    apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
      build-essential gcc \
      libffi-dev libbz2-dev libtiff5-dev libwebp-dev tk8.6-dev \
      libldap2-dev libsasl2-dev libmariadb-dev libpq-dev \
      libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev \
      liblcms2-dev pkg-config rlwrap redis-tools cron wget \
    && rm -rf /var/lib/apt/lists/*

ARG APPS_JSON_BASE64
RUN if [ -n "${APPS_JSON_BASE64:-}" ]; then \
      mkdir -p /opt/frappe && echo "${APPS_JSON_BASE64}" | base64 -d > /opt/frappe/apps.json && chown -R frappe:frappe /opt/frappe; \
    fi

USER frappe
WORKDIR /home/frappe

ARG FRAPPE_BRANCH=version-15
ARG FRAPPE_PATH=https://github.com/frappe/frappe

RUN set -euo pipefail; \
    APP_INSTALL_ARGS=""; \
    if [ -s /opt/frappe/apps.json ]; then APP_INSTALL_ARGS="--apps_path=/opt/frappe/apps.json"; fi; \
    bench init ${APP_INSTALL_ARGS} \
      --frappe-branch="${FRAPPE_BRANCH}" \
      --frappe-path="${FRAPPE_PATH}" \
      --no-procfile --no-backups --skip-redis-config-generation --verbose \
      /home/frappe/frappe-bench; \
    cd /home/frappe/frappe-bench; \
    echo '{}' > sites/common_site_config.json; \
    find apps -mindepth 1 -path '*/.git' -prune -exec rm -rf {} +; \
    find . -name '__pycache__' -type d -prune -exec rm -rf {} +; \
    rm -f /opt/frappe/apps.json || true

#################
#     FINAL     #
#################
FROM base AS init

COPY --from=builder --chown=frappe:frappe /home/frappe/frappe-bench /opt/frappe-bench-template

COPY frappe-entrypoint.sh /usr/local/bin/frappe-entrypoint.sh
RUN chmod +x /usr/local/bin/frappe-entrypoint.sh

USER root

WORKDIR /home/frappe/frappe-bench

ENTRYPOINT ["/usr/local/bin/frappe-entrypoint.sh"]